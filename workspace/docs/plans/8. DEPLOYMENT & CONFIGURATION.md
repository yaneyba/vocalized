---
tags:
  - pipeline
  - configuration
  - deployment
---
## 8.1 Project Structure

```
vocalized/
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ api-gateway/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ wrangler.toml
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ voice-gateway/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â””â”€â”€ failover.ts
â”‚   â”‚   â”œâ”€â”€ wrangler.toml
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ call-management/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ router.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ executor.ts
â”‚   â”‚   â”‚   â””â”€â”€ webhooks.ts
â”‚   â”‚   â”œâ”€â”€ wrangler.toml
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ integration-hub/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ oauth.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ connectors/
â”‚   â”‚   â”‚   â””â”€â”€ sync.ts
â”‚   â”‚   â”œâ”€â”€ wrangler.toml
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ billing-analytics/
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ index.ts
â”‚       â”‚   â”œâ”€â”€ billing.ts
â”‚       â”‚   â”œâ”€â”€ analytics.ts
â”‚       â”‚   â””â”€â”€ reports.ts
â”‚       â”œâ”€â”€ wrangler.toml
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ client-portal/          # app.vocalized.app
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ admin-portal/           # admin.vocalized.app
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ public/
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ schema.sql
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 001_initial.sql
â”‚       â”œâ”€â”€ 002_add_integrations.sql
â”‚       â””â”€â”€ 003_add_billing.sql
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ API.md
    â”œâ”€â”€ DEPLOYMENT.md
    â””â”€â”€ ARCHITECTURE.md
```

---

## 8.2 Wrangler Configuration Files

### API Gateway Worker

```toml
# workers/api-gateway/wrangler.toml

name = "vocalized-api-gateway"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# Bindings
[[d1_databases]]
binding = "DB"
database_name = "vocalized-production"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[[r2_buckets]]
binding = "R2_RECORDINGS"
bucket_name = "vocalized-recordings"

# Environment variables
[vars]
ENVIRONMENT = "production"
JWT_SECRET = "your-jwt-secret"  # Use wrangler secret for production

# Routes
routes = [
  { pattern = "api.vocalized.app/*", zone_name = "vocalized.app" }
]

# Limits
[limits]
cpu_ms = 50000
```

---

### Voice AI Gateway Worker

```toml
# workers/voice-gateway/wrangler.toml

name = "vocalized-voice-gateway"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "vocalized-production"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[[durable_objects.bindings]]
name = "PROVIDER_HEALTH_DO"
class_name = "ProviderHealthMonitor"
script_name = "vocalized-voice-gateway"

[[migrations]]
tag = "v1"
new_classes = ["ProviderHealthMonitor"]

[vars]
ENVIRONMENT = "production"

# Secrets (set via wrangler secret put)
# ELEVENLABS_API_KEY
# DEEPGRAM_API_KEY
# VAPI_API_KEY
# RETELL_API_KEY

routes = [
  { pattern = "voice.vocalized.app/*", zone_name = "vocalized.app" }
]

[limits]
cpu_ms = 100000
```

---

### Call Management Worker

```toml
# workers/call-management/wrangler.toml

name = "vocalized-call-management"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "vocalized-production"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[[r2_buckets]]
binding = "R2_RECORDINGS"
bucket_name = "vocalized-recordings"

[[durable_objects.bindings]]
name = "CALL_STATE_DO"
class_name = "CallStateDO"
script_name = "vocalized-call-management"

[[migrations]]
tag = "v1"
new_classes = ["CallStateDO"]

[[queues.producers]]
binding = "CALL_QUEUE"
queue = "vocalized-call-queue"

[[queues.consumers]]
queue = "vocalized-call-queue"
max_batch_size = 10
max_batch_timeout = 30

[vars]
ENVIRONMENT = "production"

# Secrets
# TWILIO_ACCOUNT_SID
# TWILIO_AUTH_TOKEN

routes = [
  { pattern = "calls.vocalized.app/*", zone_name = "vocalized.app" }
]

[limits]
cpu_ms = 100000
```

---

### Integration Hub Worker

```toml
# workers/integration-hub/wrangler.toml

name = "vocalized-integration-hub"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "vocalized-production"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "vocalized-sync-queue"

[[queues.consumers]]
queue = "vocalized-sync-queue"
max_batch_size = 5
max_batch_timeout = 60

[vars]
ENVIRONMENT = "production"

# Secrets (OAuth credentials)
# GOOGLE_CLIENT_ID
# GOOGLE_CLIENT_SECRET
# SALESFORCE_CLIENT_ID
# SALESFORCE_CLIENT_SECRET
# HUBSPOT_CLIENT_ID
# HUBSPOT_CLIENT_SECRET
# SQUARE_APPLICATION_ID
# SQUARE_APPLICATION_SECRET
# FRESHA_CLIENT_ID
# FRESHA_CLIENT_SECRET

routes = [
  { pattern = "integrations.vocalized.app/*", zone_name = "vocalized.app" }
]
```

---

### Billing & Analytics Worker

```toml
# workers/billing-analytics/wrangler.toml

name = "vocalized-billing-analytics"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "vocalized-production"
database_id = "your-database-id"

[[kv_namespaces]]
binding = "KV"
id = "your-kv-namespace-id"

[vars]
ENVIRONMENT = "production"

# Secrets
# STRIPE_SECRET_KEY
# STRIPE_WEBHOOK_SECRET

# Cron triggers
[[triggers.crons]]
schedule = "0 0 * * *"  # Daily at midnight

[[triggers.crons]]
schedule = "0 1 1 * *"  # Monthly on 1st at 1 AM

[[triggers.crons]]
schedule = "0 * * * *"  # Hourly

[[triggers.crons]]
schedule = "0 2 * * *"  # Daily at 2 AM

routes = [
  { pattern = "billing.vocalized.app/*", zone_name = "vocalized.app" }
]
```

---

## 8.3 Database Setup Script

```bash
#!/bin/bash
# database/setup.sh

# Create D1 database
wrangler d1 create vocalized-production

# Note the database ID and update wrangler.toml files

# Apply schema
wrangler d1 execute vocalized-production --file=./schema.sql

# Apply migrations
for migration in migrations/*.sql; do
    echo "Applying migration: $migration"
    wrangler d1 execute vocalized-production --file="$migration"
done

echo "Database setup complete!"
```

---

## 8.4 Environment Secrets Setup

```bash
#!/bin/bash
# scripts/setup-secrets.sh

# Set this up for each worker

echo "Setting up secrets for Vocalized workers..."

# API Gateway
cd workers/api-gateway
wrangler secret put JWT_SECRET

# Voice Gateway
cd ../voice-gateway
wrangler secret put ELEVENLABS_API_KEY
wrangler secret put DEEPGRAM_API_KEY
wrangler secret put VAPI_API_KEY
wrangler secret put RETELL_API_KEY

# Call Management
cd ../call-management
wrangler secret put TWILIO_ACCOUNT_SID
wrangler secret put TWILIO_AUTH_TOKEN

# Integration Hub
cd ../integration-hub
wrangler secret put GOOGLE_CLIENT_ID
wrangler secret put GOOGLE_CLIENT_SECRET
wrangler secret put SALESFORCE_CLIENT_ID
wrangler secret put SALESFORCE_CLIENT_SECRET
wrangler secret put HUBSPOT_CLIENT_ID
wrangler secret put HUBSPOT_CLIENT_SECRET
wrangler secret put SQUARE_APPLICATION_ID
wrangler secret put SQUARE_APPLICATION_SECRET
wrangler secret put FRESHA_CLIENT_ID
wrangler secret put FRESHA_CLIENT_SECRET

# Billing & Analytics
cd ../billing-analytics
wrangler secret put STRIPE_SECRET_KEY
wrangler secret put STRIPE_WEBHOOK_SECRET

echo "Secrets setup complete!"
```

---

## 8.5 Deployment Scripts

### Deploy All Workers

```bash
#!/bin/bash
# scripts/deploy-all.sh

set -e

echo "ðŸš€ Deploying Vocalized Platform..."

# Deploy workers in order
WORKERS=(
    "api-gateway"
    "voice-gateway"
    "call-management"
    "integration-hub"
    "billing-analytics"
)

for worker in "${WORKERS[@]}"; do
    echo ""
    echo "ðŸ“¦ Deploying $worker..."
    cd "workers/$worker"
    npm install
    npm run build
    wrangler deploy
    cd ../..
    echo "âœ… $worker deployed"
done

echo ""
echo "ðŸŽ‰ All workers deployed successfully!"
```

---

### Deploy Single Worker

```bash
#!/bin/bash
# scripts/deploy-worker.sh

WORKER=$1

if [ -z "$WORKER" ]; then
    echo "Usage: ./deploy-worker.sh <worker-name>"
    echo "Available workers: api-gateway, voice-gateway, call-management, integration-hub, billing-analytics"
    exit 1
fi

echo "ðŸš€ Deploying $WORKER..."

cd "workers/$WORKER"
npm install
npm run build
wrangler deploy

echo "âœ… $WORKER deployed successfully!"
```

---

## 8.6 Frontend Deployment

### Client Portal (Pages)

```toml
# frontend/client-portal/wrangler.toml

name = "vocalized-client-portal"
compatibility_date = "2024-01-01"

pages_build_output_dir = "dist"

[env.production]
routes = [
  { pattern = "app.vocalized.app", zone_name = "vocalized.app" }
]

[env.production.vars]
API_URL = "https://api.vocalized.app"
ENVIRONMENT = "production"
```

### Admin Portal (Pages)

```toml
# frontend/admin-portal/wrangler.toml

name = "vocalized-admin-portal"
compatibility_date = "2024-01-01"

pages_build_output_dir = "dist"

[env.production]
routes = [
  { pattern = "admin.vocalized.app", zone_name = "vocalized.app" }
]

[env.production.vars]
API_URL = "https://api.vocalized.app"
ENVIRONMENT = "production"
```

---

## 8.7 DNS Configuration

```bash
# DNS Records for Cloudflare

# API Gateway
api.vocalized.app       CNAME   vocalized-api-gateway.workers.dev

# Voice Gateway
voice.vocalized.app     CNAME   vocalized-voice-gateway.workers.dev

# Call Management
calls.vocalized.app     CNAME   vocalized-call-management.workers.dev

# Integration Hub
integrations.vocalized.app  CNAME   vocalized-integration-hub.workers.dev

# Billing & Analytics
billing.vocalized.app   CNAME   vocalized-billing-analytics.workers.dev

# Client Portal
app.vocalized.app       CNAME   vocalized-client-portal.pages.dev

# Admin Portal
admin.vocalized.app     CNAME   vocalized-admin-portal.pages.dev

# Recordings (R2 Custom Domain)
recordings.vocalized.app    CNAME   your-r2-bucket.r2.dev
```

---

## 8.8 Monitoring & Logging Setup

```typescript
// workers/shared/monitoring.ts

export class MonitoringService {
  constructor(private env: Env) {}

  async logError(
    error: Error,
    context: {
      workerId: string;
      endpoint: string;
      userId?: string;
      workspaceId?: string;
    }
  ): Promise<void> {
    
    const errorLog = {
      timestamp: Date.now(),
      workerId: context.workerId,
      endpoint: context.endpoint,
      error: {
        message: error.message,
        stack: error.stack,
        name: error.name
      },
      userId: context.userId,
      workspaceId: context.workspaceId
    };

    // Log to D1
    await this.env.DB
      .prepare(`
        INSERT INTO error_logs
        (id, worker_id, endpoint, error_message, error_stack, 
         user_id, workspace_id, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `)
      .bind(
        crypto.randomUUID(),
        context.workerId,
        context.endpoint,
        error.message,
        error.stack || null,
        context.userId || null,
        context.workspaceId || null,
        Date.now()
      )
      .run();

    // Also log to console for Cloudflare dashboard
    console.error('Error:', errorLog);
  }

  async logMetric(
    metric: {
      name: string;
      value: number;
      tags?: Record<string, string>;
    }
  ): Promise<void> {
    
    // Store metrics in KV or Analytics Engine
    await this.env.KV.put(
      `metric:${metric.name}:${Date.now()}`,
      JSON.stringify({
        value: metric.value,
        tags: metric.tags,
        timestamp: Date.now()
      }),
      { expirationTtl: 86400 } // 24 hours
    );
  }

  async trackRequest(
    endpoint: string,
    duration: number,
    status: number
  ): Promise<void> {
    
    await this.logMetric({
      name: 'request_duration',
      value: duration,
      tags: {
        endpoint,
        status: status.toString()
      }
    });
  }
}

// Add to schema
/*
CREATE TABLE error_logs (
    id TEXT PRIMARY KEY,
    worker_id TEXT NOT NULL,
    endpoint TEXT NOT NULL,
    error_message TEXT NOT NULL,
    error_stack TEXT,
    user_id TEXT,
    workspace_id TEXT,
    created_at INTEGER NOT NULL
);

CREATE INDEX idx_error_logs_worker ON error_logs(worker_id);
CREATE INDEX idx_error_logs_workspace ON error_logs(workspace_id);
CREATE INDEX idx_error_logs_created ON error_logs(created_at);
*/
```

---

## 8.9 Health Check Endpoints

```typescript
// Add to each worker

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);
    
    // Health check endpoint
    if (url.pathname === '/health') {
      return await handleHealthCheck(env);
    }

    // Regular request handling...
  }
};

async function handleHealthCheck(env: Env): Promise<Response> {
  const checks = {
    database: false,
    kv: false,
    timestamp: Date.now()
  };

  try {
    // Check D1
    await env.DB.prepare('SELECT 1').first();
    checks.database = true;
  } catch (error) {
    console.error('Database health check failed:', error);
  }

  try {
    // Check KV
    await env.KV.put('health-check', 'ok', { expirationTtl: 60 });
    const value = await env.KV.get('health-check');
    checks.kv = value === 'ok';
  } catch (error) {
    console.error('KV health check failed:', error);
  }

  const allHealthy = checks.database && checks.kv;

  return Response.json(checks, {
    status: allHealthy ? 200 : 503
  });
}
```

---

## 8.10 CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/deploy.yml

name: Deploy Vocalized Platform

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-workers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker:
          - api-gateway
          - voice-gateway
          - call-management
          - integration-hub
          - billing-analytics
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd workers/${{ matrix.worker }}
          npm ci
      
      - name: Build
        run: |
          cd workers/${{ matrix.worker }}
          npm run build
      
      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: workers/${{ matrix.worker }}
          command: deploy

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-workers
    strategy:
      matrix:
        app:
          - client-portal
          - admin-portal
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend/${{ matrix.app }}
          npm ci
      
      - name: Build
        run: |
          cd frontend/${{ matrix.app }}
          npm run build
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: vocalized-${{ matrix.app }}
          directory: frontend/${{ matrix.app }}/dist
```

---

## 8.11 Environment-Specific Configuration

```typescript
// workers/shared/config.ts

interface Config {
  apiUrl: string;
  environment: 'development' | 'staging' | 'production';
  database: {
    maxRetries: number;
    timeout: number;
  };
  rateLimit: {
    requestsPerMinute: number;
  };
  features: {
    advancedAnalytics: boolean;
    multiRegion: boolean;
  };
}

export function getConfig(env: Env): Config {
  const environment = env.ENVIRONMENT || 'development';

  const configs: Record<string, Config> = {
    development: {
      apiUrl: 'http://localhost:8787',
      environment: 'development',
      database: {
        maxRetries: 3,
        timeout: 5000
      },
      rateLimit: {
        requestsPerMinute: 1000
      },
      features: {
        advancedAnalytics: true,
        multiRegion: false
      }
    },
    staging: {
      apiUrl: 'https://api-staging.vocalized.app',
      environment: 'staging',
      database: {
        maxRetries: 5,
        timeout: 10000
      },
      rateLimit: {
        requestsPerMinute: 500
      },
      features: {
        advancedAnalytics: true,
        multiRegion: false
      }
    },
    production: {
      apiUrl: 'https://api.vocalized.app',
      environment: 'production',
      database: {
        maxRetries: 5,
        timeout: 10000
      },
      rateLimit: {
        requestsPerMinute: 100
      },
      features: {
        advancedAnalytics: true,
        multiRegion: true
      }
    }
  };

  return configs[environment] || configs.development;
}
```

---

## 8.12 Quick Start Guide

```markdown
# Vocalized - Quick Start Guide

## Prerequisites

- Node.js 18+
- Cloudflare account
- Wrangler CLI installed: `npm install -g wrangler`

## Initial Setup

1. **Clone the repository**
   ```bash
   git clone https://github.com/yourusername/vocalized.git
   cd vocalized
   ```

2. **Authenticate with Cloudflare**
   ```bash
   wrangler login
   ```

3. **Create D1 Database**
   ```bash
   wrangler d1 create vocalized-production
   # Copy the database ID to wrangler.toml files
   ```

4. **Setup Database Schema**
   ```bash
   ./database/setup.sh
   ```

5. **Create KV Namespaces**
   ```bash
   wrangler kv:namespace create "vocalized-kv"
   # Copy namespace ID to wrangler.toml files
   ```

6. **Create R2 Buckets**
   ```bash
   wrangler r2 bucket create vocalized-recordings
   ```

7. **Setup Secrets**
   ```bash
   ./scripts/setup-secrets.sh
   ```

8. **Deploy Workers**
   ```bash
   ./scripts/deploy-all.sh
   ```

9. **Deploy Frontend**
   ```bash
   cd frontend/client-portal
   npm install
   npm run build
   wrangler pages deploy dist

   cd ../admin-portal
   npm install
   npm run build
   wrangler pages deploy dist
   ```

10. **Configure DNS**
    - Add the DNS records from section 8.7

## Development

```bash
# Run worker locally
cd workers/api-gateway
wrangler dev

# Run with local D1
wrangler dev --local

# Tail logs
wrangler tail
```

## Testing

```bash
# Run tests
npm test

# Test specific worker
cd workers/api-gateway
npm test
```

## Monitoring

- Cloudflare Dashboard: https://dash.cloudflare.com
- View logs: `wrangler tail <worker-name>`
- Health checks: `https://api.vocalized.app/health`

---

**ðŸŽ‰ This completes the entire Vocalized platform architecture documentation! You now have:**

1. âœ… Complete database schema
2. âœ… All API endpoints (Admin & Client)
3. âœ… Authentication & Authorization system
4. âœ… Voice AI Gateway with multi-provider support
5. âœ… Call Management Engine with Twilio integration
6. âœ… Integration Hub with OAuth flows
7. âœ… Billing & Analytics system with Stripe
8. âœ… Deployment configuration and scripts

Ready to start building! ðŸš€
#vocalized