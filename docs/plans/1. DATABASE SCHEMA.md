---
tags:
  - vocalized
  - d1-database
  - database-schema
  - pipeline
tag:
---
## 1.1 Platform Admins (YOU)

```sql
-- ============================================
-- PLATFORM ADMINS
-- These are YOU and your team who manage the platform
-- ============================================

CREATE TABLE platform_admins (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    password_hash TEXT NOT NULL,
    role TEXT DEFAULT 'admin' CHECK(role IN ('super_admin', 'admin', 'support')),
    -- super_admin: Full access (you)
    -- admin: Can manage workspaces, view analytics
    -- support: Read-only access for customer support
    is_active INTEGER DEFAULT 1,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    last_login INTEGER
);

CREATE INDEX idx_platform_admin_email ON platform_admins(email);

-- Admin Activity Logs (Audit Trail)
CREATE TABLE admin_activity_logs (
    id TEXT PRIMARY KEY,
    admin_id TEXT NOT NULL,
    action TEXT NOT NULL, -- 'viewed_workspace', 'suspended_workspace', 'updated_provider_config'
    resource_type TEXT, -- 'workspace', 'user', 'provider', 'integration'
    resource_id TEXT,
    details TEXT, -- JSON with additional context
    ip_address TEXT,
    timestamp INTEGER NOT NULL,
    FOREIGN KEY (admin_id) REFERENCES platform_admins(id) ON DELETE CASCADE
);

CREATE INDEX idx_admin_logs_admin ON admin_activity_logs(admin_id);
CREATE INDEX idx_admin_logs_timestamp ON admin_activity_logs(timestamp);
CREATE INDEX idx_admin_logs_resource ON admin_activity_logs(resource_type, resource_id);
```

---

## 1.2 Client Users (YOUR CUSTOMERS)

```sql
-- ============================================
-- CLIENT USERS
-- These are the businesses (nail salon, dental office) who use your platform
-- ============================================

CREATE TABLE client_users (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    password_hash TEXT NOT NULL,
    is_active INTEGER DEFAULT 1,
    email_verified INTEGER DEFAULT 0,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    last_login INTEGER
);

CREATE INDEX idx_client_user_email ON client_users(email);
```

---

## 1.3 Workspaces (CLIENT TENANTS)

```sql
-- ============================================
-- WORKSPACES
-- Each client user creates a workspace (their isolated environment)
-- ============================================

CREATE TABLE workspaces (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    industry TEXT, -- dental, auto_repair, restaurant, real_estate
    owner_id TEXT NOT NULL, -- The client_user who created this workspace
    status TEXT DEFAULT 'active' CHECK(status IN ('active', 'trial', 'suspended', 'cancelled')),
    subscription_tier TEXT DEFAULT 'starter' CHECK(subscription_tier IN ('starter', 'professional', 'enterprise')),
    trial_ends_at INTEGER,
    timezone TEXT DEFAULT 'UTC',
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (owner_id) REFERENCES client_users(id) ON DELETE CASCADE
);

CREATE INDEX idx_workspace_owner ON workspaces(owner_id);
CREATE INDEX idx_workspace_status ON workspaces(status);

-- Workspace Members (Team Collaboration)
-- A workspace can have multiple client_users as members
CREATE TABLE workspace_members (
    workspace_id TEXT NOT NULL,
    user_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('owner', 'admin', 'member', 'viewer')),
    -- owner: Full control (the person who created workspace)
    -- admin: Can manage agents, integrations, billing
    -- member: Can view calls, analytics, but not change settings
    -- viewer: Read-only access
    invited_by TEXT, -- user_id who sent the invite
    joined_at INTEGER NOT NULL,
    PRIMARY KEY (workspace_id, user_id),
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES client_users(id) ON DELETE CASCADE
);

CREATE INDEX idx_member_workspace ON workspace_members(workspace_id);
CREATE INDEX idx_member_user ON workspace_members(user_id);
```

---

## 1.4 Phone Numbers

```sql
-- ============================================
-- PHONE NUMBERS
-- ============================================

CREATE TABLE phone_numbers (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    phone_number TEXT UNIQUE NOT NULL, -- E.164 format: +14155551234
    provider TEXT NOT NULL, -- twilio, telnyx
    provider_sid TEXT, -- Provider's identifier
    friendly_name TEXT, -- Optional label like "Main Line"
    status TEXT DEFAULT 'active' CHECK(status IN ('active', 'inactive', 'porting')),
    created_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);

CREATE INDEX idx_phone_workspace ON phone_numbers(workspace_id);
CREATE INDEX idx_phone_number ON phone_numbers(phone_number);
```

---

## 1.5 Agent Templates

```sql
-- ============================================
-- AGENT TEMPLATES
-- Pre-built templates created by platform admins
-- ============================================

CREATE TABLE agent_templates (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    industry TEXT NOT NULL, -- dental, auto_repair, restaurant
    description TEXT,
    default_config TEXT NOT NULL, -- JSON: call flows, scripts
    is_public INTEGER DEFAULT 1, -- 1=available to all clients, 0=admin only
    created_by_admin_id TEXT, -- Which admin created this template
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (created_by_admin_id) REFERENCES platform_admins(id) ON DELETE SET NULL
);

CREATE INDEX idx_template_industry ON agent_templates(industry);
CREATE INDEX idx_template_public ON agent_templates(is_public);
```

---

## 1.6 Voice Agents

```sql
-- ============================================
-- VOICE AGENTS
-- The actual AI agents created by clients
-- ============================================

CREATE TABLE voice_agents (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    phone_number_id TEXT,
    name TEXT NOT NULL,
    template_id TEXT, -- NULL if built from scratch
    config TEXT NOT NULL, -- JSON: call flows, scripts, voice settings
    voice_provider TEXT NOT NULL, -- elevenlabs, vapi, retell
    voice_config TEXT NOT NULL, -- JSON: voice_id, model, settings
    status TEXT DEFAULT 'draft' CHECK(status IN ('draft', 'testing', 'live', 'paused')),
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    activated_at INTEGER,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
    FOREIGN KEY (phone_number_id) REFERENCES phone_numbers(id) ON DELETE SET NULL,
    FOREIGN KEY (template_id) REFERENCES agent_templates(id) ON DELETE SET NULL
);

CREATE INDEX idx_agent_workspace ON voice_agents(workspace_id);
CREATE INDEX idx_agent_phone ON voice_agents(phone_number_id);
CREATE INDEX idx_agent_status ON voice_agents(status);
```

---

## 1.7 Voice AI Gateway Configuration

```sql
-- ============================================
-- PLATFORM PROVIDER CONFIGS (Admin Managed)
-- These are YOUR master API keys for each provider
-- ============================================

CREATE TABLE platform_provider_configs (
    provider TEXT PRIMARY KEY, -- elevenlabs, vapi, retell, deepgram, bolna
    api_key_encrypted TEXT NOT NULL, -- Platform's master API key (encrypted)
    config TEXT, -- JSON: global settings
    priority INTEGER DEFAULT 0, -- Failover order
    is_enabled INTEGER DEFAULT 1,
    cost_per_unit REAL, -- For billing calculation
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- ============================================
-- WORKSPACE PROVIDER CONFIGS (Client Optional)
-- Clients can optionally bring their own API keys
-- ============================================

CREATE TABLE workspace_provider_configs (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    provider TEXT NOT NULL, -- elevenlabs, vapi, retell, deepgram
    uses_platform_key INTEGER DEFAULT 1, -- 1=use YOUR key, 0=client brings own key
    api_key_encrypted TEXT, -- Only if client brings own key (encrypted)
    config TEXT, -- JSON: provider-specific settings
    is_enabled INTEGER DEFAULT 1,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
    UNIQUE(workspace_id, provider)
);

CREATE INDEX idx_workspace_provider ON workspace_provider_configs(workspace_id);

-- ============================================
-- PROVIDER SELECTION STRATEGY (Per Workspace)
-- ============================================

CREATE TABLE workspace_provider_strategies (
    workspace_id TEXT PRIMARY KEY,
    strategy TEXT NOT NULL CHECK(strategy IN ('auto', 'cost_optimized', 'quality_first', 'specific', 'custom')),
    config TEXT, -- JSON: rules for custom strategy
    fallback_enabled INTEGER DEFAULT 1,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);

-- ============================================
-- PROVIDER HEALTH STATUS (Platform-Wide)
-- Managed by Durable Objects, monitored by admin
-- ============================================

CREATE TABLE provider_health_status (
    provider TEXT NOT NULL,
    region TEXT NOT NULL,
    status TEXT NOT NULL CHECK(status IN ('healthy', 'degraded', 'down')),
    last_check INTEGER NOT NULL,
    error_rate REAL DEFAULT 0.0,
    avg_latency INTEGER, -- milliseconds
    details TEXT, -- JSON: error messages, etc.
    PRIMARY KEY (provider, region)
);
```

---

## 1.8 Integrations

```sql
-- ============================================
-- WORKSPACE INTEGRATIONS
-- CRM, Calendar, Booking systems connected by clients
-- ============================================

CREATE TABLE workspace_integrations (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    integration_type TEXT NOT NULL, -- salesforce, hubspot, google_calendar, square, fresha
    name TEXT NOT NULL, -- User-friendly name
    status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'connected', 'error', 'disconnected')),
    auth_type TEXT NOT NULL, -- oauth, api_key
    credentials_encrypted TEXT, -- Encrypted tokens/keys (or reference to KV)
    config TEXT, -- JSON: sync rules, field mappings
    last_sync_at INTEGER,
    last_sync_status TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);

CREATE INDEX idx_integration_workspace ON workspace_integrations(workspace_id);
CREATE INDEX idx_integration_type ON workspace_integrations(integration_type);
CREATE INDEX idx_integration_status ON workspace_integrations(status);

-- Integration Sync Logs
CREATE TABLE integration_sync_logs (
    id TEXT PRIMARY KEY,
    integration_id TEXT NOT NULL,
    sync_type TEXT NOT NULL, -- full, incremental
    status TEXT NOT NULL CHECK(status IN ('started', 'completed', 'failed')),
    records_synced INTEGER DEFAULT 0,
    error_message TEXT,
    started_at INTEGER NOT NULL,
    completed_at INTEGER,
    FOREIGN KEY (integration_id) REFERENCES workspace_integrations(id) ON DELETE CASCADE
);

CREATE INDEX idx_sync_integration ON integration_sync_logs(integration_id);
CREATE INDEX idx_sync_started ON integration_sync_logs(started_at);
```

---

## 1.9 Calls

```sql
-- ============================================
-- CALLS
-- All phone calls handled by the platform
-- ============================================

CREATE TABLE calls (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    agent_id TEXT NOT NULL,
    phone_number_id TEXT NOT NULL,
    caller_number TEXT NOT NULL, -- E.164 format
    caller_name TEXT, -- If available from caller ID
    direction TEXT NOT NULL CHECK(direction IN ('inbound', 'outbound')),
    status TEXT NOT NULL CHECK(status IN ('queued', 'ringing', 'in-progress', 'completed', 'failed', 'busy', 'no-answer')),
    provider_call_sid TEXT, -- Twilio/Telnyx call ID
    voice_provider_used TEXT NOT NULL, -- Which AI provider handled this call
    duration_seconds INTEGER,
    recording_url TEXT, -- R2 URL
    transcription TEXT,
    summary TEXT, -- AI-generated call summary
    sentiment TEXT, -- positive, neutral, negative
    metadata TEXT, -- JSON: intent, extracted entities, custom fields
    cost_total REAL, -- Total cost for this call
    started_at INTEGER NOT NULL,
    ended_at INTEGER,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
    FOREIGN KEY (agent_id) REFERENCES voice_agents(id) ON DELETE CASCADE,
    FOREIGN KEY (phone_number_id) REFERENCES phone_numbers(id) ON DELETE CASCADE
);

CREATE INDEX idx_call_workspace ON calls(workspace_id);
CREATE INDEX idx_call_agent ON calls(agent_id);
CREATE INDEX idx_call_started ON calls(started_at);
CREATE INDEX idx_call_status ON calls(status);
CREATE INDEX idx_call_direction ON calls(direction);

-- Call Events (for real-time tracking)
CREATE TABLE call_events (
    id TEXT PRIMARY KEY,
    call_id TEXT NOT NULL,
    event_type TEXT NOT NULL, -- initiated, answered, transferred, ended, error
    event_data TEXT, -- JSON
    timestamp INTEGER NOT NULL,
    FOREIGN KEY (call_id) REFERENCES calls(id) ON DELETE CASCADE
);

CREATE INDEX idx_event_call ON call_events(call_id);
CREATE INDEX idx_event_timestamp ON call_events(timestamp);
```

---

## 1.10 Usage & Billing

```sql
-- ============================================
-- USAGE RECORDS
-- Track every billable action
-- ============================================

CREATE TABLE usage_records (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    call_id TEXT,
    resource_type TEXT NOT NULL, -- call_minutes, transcription, storage, ai_tokens
    provider TEXT NOT NULL, -- Which provider was used
    quantity REAL NOT NULL, -- minutes, characters, bytes
    unit_cost REAL NOT NULL, -- Cost per unit from provider
    total_cost REAL NOT NULL, -- quantity * unit_cost
    markup_percentage REAL DEFAULT 20, -- Your platform markup (%)
    final_cost REAL NOT NULL, -- total_cost + markup
    billing_period_id TEXT, -- Link to billing period
    created_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE,
    FOREIGN KEY (call_id) REFERENCES calls(id) ON DELETE SET NULL
);

CREATE INDEX idx_usage_workspace ON usage_records(workspace_id);
CREATE INDEX idx_usage_created ON usage_records(created_at);
CREATE INDEX idx_usage_billing_period ON usage_records(billing_period_id);

-- ============================================
-- BILLING PERIODS
-- Monthly billing cycles per workspace
-- ============================================

CREATE TABLE billing_periods (
    id TEXT PRIMARY KEY,
    workspace_id TEXT NOT NULL,
    period_start INTEGER NOT NULL,
    period_end INTEGER NOT NULL,
    subtotal REAL DEFAULT 0.0, -- Total usage costs
    subscription_fee REAL DEFAULT 0.0, -- Monthly subscription if applicable
    total_amount REAL DEFAULT 0.0, -- subtotal + subscription_fee
    status TEXT DEFAULT 'current' CHECK(status IN ('current', 'finalized', 'paid', 'overdue')),
    stripe_invoice_id TEXT,
    paid_at INTEGER,
    created_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);

CREATE INDEX idx_billing_workspace ON billing_periods(workspace_id);
CREATE INDEX idx_billing_status ON billing_periods(status);
CREATE INDEX idx_billing_period ON billing_periods(period_start, period_end);

-- ============================================
-- WORKSPACE BILLING SETTINGS
-- ============================================

CREATE TABLE workspace_billing_settings (
    workspace_id TEXT PRIMARY KEY,
    usage_limit_monthly REAL, -- Dollar limit per month
    alert_threshold_percentage REAL DEFAULT 80, -- Alert at 80% of limit
    auto_pause_on_limit INTEGER DEFAULT 0, -- Auto-pause agents when limit reached
    payment_method_id TEXT, -- Stripe payment method ID
    billing_email TEXT,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (workspace_id) REFERENCES workspaces(id) ON DELETE CASCADE
);
```

---

## 1.11 Platform Settings (ADMIN MANAGED)

```sql
-- ============================================
-- PLATFORM SETTINGS
-- Global settings managed by YOU (admin)
-- ============================================

CREATE TABLE platform_settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL, -- JSON for complex values
    description TEXT,
    updated_by_admin_id TEXT,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (updated_by_admin_id) REFERENCES platform_admins(id) ON DELETE SET NULL
);

-- Example settings stored:
-- - default_subscription_tier: "starter"
-- - trial_duration_days: 14
-- - available_integrations: ["salesforce", "hubspot", "google_calendar"]
-- - feature_flags: {"advanced_analytics": true, "custom_domains": false}
-- - pricing_markup_percentage: 20

-- ============================================
-- SUBSCRIPTION TIERS
-- Pricing plans managed by admin
-- ============================================

CREATE TABLE subscription_tiers (
    tier_name TEXT PRIMARY KEY, -- starter, professional, enterprise
    display_name TEXT NOT NULL,
    monthly_fee REAL NOT NULL,
    included_minutes INTEGER, -- Free minutes per month
    price_per_minute REAL NOT NULL, -- After free minutes
    max_agents INTEGER, -- Max number of agents allowed
    max_phone_numbers INTEGER,
    features TEXT NOT NULL, -- JSON array of feature flags
    is_active INTEGER DEFAULT 1,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- Seed data example:
INSERT INTO subscription_tiers VALUES
('starter', 'Starter', 29.99, 100, 0.05, 1, 1, '["basic_analytics"]', 1, 1234567890, 1234567890),
('professional', 'Professional', 99.99, 500, 0.04, 5, 3, '["basic_analytics", "advanced_analytics", "priority_support"]', 1, 1234567890, 1234567890),
('enterprise', 'Enterprise', 299.99, 2000, 0.03, 999, 10, '["basic_analytics", "advanced_analytics", "priority_support", "custom_integrations", "dedicated_account_manager"]', 1, 1234567890, 1234567890);
```

---

#vocalized